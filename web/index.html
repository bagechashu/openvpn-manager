<!-- @format -->

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Title of the page -->
    <title>openvpn manager</title>

    <!-- Mobi.css -->
    <link rel="stylesheet" href="https://unpkg.com/mobi.css/dist/mobi.min.css" />
    <!-- Add plugins as you like -->
    <link rel="stylesheet" href="https://unpkg.com/mobi-plugin-reset/dist/mobi-plugin-reset.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/mobi-plugin-flexbox/dist/mobi-plugin-flexbox.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/mobi-plugin-form/dist/mobi-plugin-form.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/mobi-plugin-color/dist/mobi-plugin-color.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/mobi-plugin-scroll-view/dist/mobi-plugin-scroll-view.min.css" />
    <title>openvpn</title>
    <style>
      /* 通用样式 */
      body {
        margin: 0;
        padding: 0;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      footer {
        text-align: left;
        padding: 8px 0;
      }

      /* 对于非移动设备（宽度大于768px） */
      @media (min-width: 768px) {
        body {
          display: flex;
          justify-content: center;
          /* 水平居中 */
          align-items: center;
          /* 垂直居中 */
          height: 100vh;
          /* 铺满整个屏幕高度 */
          background-color: #f2f2f2;
          /* 非 body 部分浅灰色 */
        }

        #content {
          background-color: white;
          /* body 内容部分白色 */
          padding: 20px;
        }
      }

      ul {
        list-style: none;
        padding: 0;
      }

      li {
        margin-bottom: 10px;
        border-radius: 5px;
        background-color: #cfe2ff;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .user-details {
        display: flex;
      }
    </style>
  </head>

  <body>
    <div class="container-wider">
      <!-- 页面内容将显示在这里 -->
      <header onclick="showVPNDetails()">
        <h1 style="margin-top: 8px">OpenVPN 用户管理</h1>
      </header>

      <nav>
        <div class="flex-left">
          <button class="unit container-wider btn btn-primary" onclick="showUsers()">所有用户</button>
          <button class="unit container-wider btn btn-primary" onclick="showAddUserForm()">添加用户</button>
          <button class="unit container-wider btn btn-primary" onclick="showDeleteUser()">删除用户</button>
        </div>
      </nav>

      <div class="scroll-view" style="height: 80vh">
        <section id="content" class="top-gap-big">
          <!-- 功能内容将显示在这里 -->
          <h2 class="text-warning">请谨慎操作</h2>
        </section>
      </div>
      <footer>&copy; <a href="https://github.com/Nyr/openvpn-install">OpenVPN based on Nyr/openvpn-install</a> 2023</footer>
    </div>

    <script>
      async function fetchData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          return await response.json();
        } catch (error) {
          console.error("Error fetching data:", error);
        }
      }

      // 获取 VPN 详情并展示所有 JSON 信息
      async function showVPNDetails() {
        const vpnData = await fetchData("/api/vpn/info");
        if (vpnData) {
          const content = document.getElementById("content");
          content.innerHTML = "<h3>VPN 详情</h3>";

          const infoList = document.createElement("ul");
          for (const key in vpnData) {
            const listItem = document.createElement("li");
            listItem.innerHTML = `
            <div class="user-details flex-left">
              <span class="unit-1-4">${key}</span>
              <span class="unit-3-4">${vpnData[key]}</span>
            </div>`;
            infoList.appendChild(listItem);
          }

          content.appendChild(infoList);
        }
      }

      // 初始加载页面时展示 VPN 详情
      showVPNDetails();
      // 通过 AJAX 获取数据
      function getUsers() {
        // 假设此处使用 fetch 或 XMLHttpRequest 请求获取用户数据，然后展示在页面上
        // 这里是模拟数据
        const users = [
          { id: 1, name: "用户1", profile: "配置文件1", addedAt: "2023-11-24" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户2", profile: "配置文件2", addedAt: "2023-11-23" },
          { id: 2, name: "用户latest", profile: "配置文件2", addedAt: "2023-11-23" },
          // 更多用户...
        ];
        return users;
      }

      // 展示所有用户
      function showUsers() {
        // 创建 XMLHttpRequest 对象
        const xhr = new XMLHttpRequest();

        // 发起 GET 请求
        xhr.open("GET", "/api/user/show", true);

        // 处理服务器响应
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              if (response.status === "success") {
                const content = document.getElementById("content");
                content.innerHTML = `<h3>${response.response.msg}</h3>`;
                const userList = document.createElement("ul");
                response.response.users.forEach((username) => {
                  const li = document.createElement("li");
                  li.innerHTML = `<div class="user-details flex-left">
                    <span class="unit">${username}</span>
                    <span class="unit"><a href="/api/user/cert/${username}.ovpn"> ovpn文件 </a></span>
                  </div>
                  `;
                  userList.appendChild(li);
                });
                content.appendChild(userList);
              } else {
                console.error("获取用户列表失败");
              }
            } else {
              console.error("发生错误");
            }
          }
        };

        // 发送请求
        xhr.send();
      }

      // 展示添加用户表单
      function showAddUserForm() {
        const content = document.getElementById("content");
        content.innerHTML = `
        <div class="form">
            <h3>添加用户</h3>
            <input type="text" id="userName" placeholder="输入用户名">
            <button class="btn" onclick="addUser()">添加用户</button>
            <div id="userAdded"></div>
        </div>
      `;
      }

      // 添加用户
      function addUser() {
        const userName = document.getElementById("userName").value;

        // 创建XMLHttpRequest对象
        const xhr = new XMLHttpRequest();

        // 设置POST请求，发送JSON数据
        xhr.open("POST", "/api/user/add", true);
        xhr.setRequestHeader("Content-Type", "application/json");

        // 处理服务器响应
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              if (response.status === "success") {
                const userAddedDiv = document.getElementById("userAdded");
                userAddedDiv.textContent = `用户名：${response.response.username}，消息：${response.response.msg}`;
              } else {
                console.error("添加用户失败");
              }
            } else {
              console.error("发生错误");
            }
          }
        };

        // 发送数据到服务器
        const data = JSON.stringify({ username: userName });
        xhr.send(data);
      }

      // 展示删除用户界面
      function showDeleteUser() {
        const users = getUsers();
        const sortedUsers = users.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));

        const content = document.getElementById("content");
        content.innerHTML = "<h3>删除用户</h3>";
        const deleteUserList = document.createElement("ul");
        sortedUsers.forEach((user) => {
          const li = document.createElement("li");
          const userContainer = document.createElement("div");
          userContainer.classList.add("user-details", "flex-left");

          const userName = document.createElement("span");
          userName.classList.add("unit");
          userName.textContent = user.name;

          const userAdded = document.createElement("span");
          userAdded.classList.add("unit");
          userAdded.textContent = user.addedAt;

          const deleteButton = document.createElement("button");
          deleteButton.classList.add("btn");
          deleteButton.style.marginTop = "0";
          deleteButton.textContent = "删除";
          deleteButton.onclick = function () {
            const password = prompt("请输入管理员密码:");
            // 假设此处验证密码，并执行删除操作
            if (password === "admin_password") {
              // 这里应该发送删除用户的请求
              alert(`用户 ${user.name} 已被删除！`);
              // 在这个示例中，只是在页面上移除了该用户信息
              li.remove();
            } else {
              alert("密码错误，无法删除用户！");
            }
          };

          userContainer.appendChild(userName);
          userContainer.appendChild(userAdded);
          userContainer.appendChild(deleteButton);
          li.appendChild(userContainer);
          deleteUserList.appendChild(li);
        });
        content.appendChild(deleteUserList);
      }
    </script>
  </body>
</html>
